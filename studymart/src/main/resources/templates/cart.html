<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('StudyMart - Giỏ hàng')}">
    <meta charset="UTF-8">
    <title>Giỏ hàng - StudyMart</title>
    <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css}">
</head>
<body>
<div th:replace="~{fragments/layout :: navbar('cart')}"></div>

<div class="container my-4">
    <h2 class="mb-3">Giỏ hàng của bạn</h2>

    <div class="table-responsive">
        <table class="table align-middle" id="cart-table">
            <thead>
            <tr>
                <th>Sản phẩm</th>
                <th class="text-end">Đơn giá</th>
                <th class="text-center">Số lượng</th>
                <th class="text-end">Thành tiền</th>
                <th></th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <h5>Thông tin giao hàng</h5>
            <div class="mb-3">
                <label class="form-label">Địa chỉ</label>
                <input type="text" class="form-control" id="shippingAddress" placeholder="VD: 123 Trường Chinh, Hà Nội">
            </div>
            <div class="mb-3">
                <label class="form-label">Số điện thoại</label>
                <input type="text" class="form-control" id="phone" placeholder="VD: 0123456789">
            </div>
            <div class="mb-3">
                <label class="form-label">Ghi chú</label>
                <textarea class="form-control" id="note" rows="2"></textarea>
            </div>
        </div>

        <div class="col-md-6">
            <h5>Thanh toán & vận chuyển</h5>
            <div class="mb-3">
                <label class="form-label">Phương thức thanh toán</label>
                <select class="form-select" id="paymentMethod"></select>
            </div>
            <div class="mb-3">
                <label class="form-label">Phương thức vận chuyển</label>
                <select class="form-select" id="transportMethod"></select>
            </div>

            <hr>
            <div class="d-flex justify-content-between">
                <span>Tiền hàng:</span>
                <span id="product-total">0</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Phí vận chuyển:</span>
                <span id="shipping-fee">0</span>
            </div>
            <div class="d-flex justify-content-between fw-bold fs-5 mt-2">
                <span>Tổng cộng:</span>
                <span id="grand-total">0</span>
            </div>

            <button class="btn btn-success w-100 mt-3" id="btn-checkout">Đặt hàng</button>
        </div>
    </div>
</div>
<div th:replace="~{fragments/layout :: footer}"></div>
<div th:replace="~{fragments/layout :: scripts}"></div>
<script th:src="@{/main.js}"></script>
<script>
    let cart = [];

    document.addEventListener("DOMContentLoaded", async () => {
      cart = loadCart();
      renderCart();
      await loadPaymentMethods();
      await loadTransportMethods();
      updateTotals();
      document.getElementById("btn-checkout").addEventListener("click", checkout);
    });

    function renderCart() {
      const tbody = document.querySelector("#cart-table tbody");
      tbody.innerHTML = "";

      if (cart.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center">Giỏ hàng trống.</td></tr>`;
        return;
      }

      cart.forEach((item, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.name}</td>
          <td class="text-end">${formatCurrency(item.price)}</td>
          <td class="text-center">
            <input type="number" min="1" value="${item.quantity}"
                   class="form-control form-control-sm text-center"
                   style="width:80px"
                   onchange="changeQuantity(${index}, this.value)">
          </td>
          <td class="text-end">${formatCurrency(item.price * item.quantity)}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})">X</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function changeQuantity(index, value) {
      const qty = parseInt(value, 10);
      if (isNaN(qty) || qty <= 0) return;
      cart[index].quantity = qty;
      saveCart(cart);
      renderCart();
      updateTotals();
    }

    function removeItem(index) {
      cart.splice(index, 1);
      saveCart(cart);
      renderCart();
      updateTotals();
    }

    async function loadPaymentMethods() {
      const select = document.getElementById("paymentMethod");
      select.innerHTML = "<option>Đang tải...</option>";
      try {
        const data = await api("/payment-methods");
        select.innerHTML = "";
        data.forEach(pm => {
          const opt = document.createElement("option");
          opt.value = pm.id;
          opt.textContent = pm.name + (pm.code ? ` (${pm.code})` : "");
          select.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
        select.innerHTML = "<option>Lỗi tải dữ liệu</option>";
      }
    }

    async function loadTransportMethods() {
      const select = document.getElementById("transportMethod");
      select.innerHTML = "<option>Đang tải...</option>";
      try {
        const data = await api("/transport-methods");
        select.innerHTML = "";
        data.forEach(tm => {
          const opt = document.createElement("option");
          opt.value = tm.id;
          opt.dataset.price = tm.price || 0;
          opt.textContent = `${tm.name} (${formatCurrency(tm.price || 0)})`;
          select.appendChild(opt);
        });
        select.addEventListener("change", updateTotals);
      } catch (e) {
        console.error(e);
        select.innerHTML = "<option>Lỗi tải dữ liệu</option>";
      }
    }

    function updateTotals() {
      const productTotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const transportSelect = document.getElementById("transportMethod");
      let shippingFee = 0;
      if (transportSelect && transportSelect.selectedOptions.length > 0) {
        shippingFee = parseFloat(transportSelect.selectedOptions[0].dataset.price || "0");
      }
      const grandTotal = productTotal + shippingFee;

      document.getElementById("product-total").textContent = formatCurrency(productTotal);
      document.getElementById("shipping-fee").textContent = formatCurrency(shippingFee);
      document.getElementById("grand-total").textContent = formatCurrency(grandTotal);
    }

    async function checkout() {
      if (cart.length === 0) return alert("Giỏ hàng trống.");

      const address = document.getElementById("shippingAddress").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const note = document.getElementById("note").value.trim();
      const paymentMethodId = document.getElementById("paymentMethod").value;
      const transportMethodId = document.getElementById("transportMethod").value;

      if (!address || !phone) return alert("Vui lòng nhập địa chỉ và số điện thoại.");

      const body = {
        paymentMethodId: Number(paymentMethodId),
        transportMethodId: Number(transportMethodId),
        shippingAddress: address,
        phone: phone,
        note: note,
        items: cart.map(c => ({ productId: c.productId, quantity: c.quantity }))
      };

      try {
        const res = await fetch(API_BASE + "/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json", ...getAuthHeader() },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error("Order error:", txt);
          return alert("Đặt hàng thất bại: " + res.status);
        }

        const data = await res.json();
        alert("Đặt hàng thành công! Mã đơn: " + data.id);

        localStorage.removeItem(CART_KEY);
        window.location.href = "/";
      } catch (e) {
        console.error(e);
        alert("Lỗi kết nối khi đặt hàng.");
      }
    }
</script>
</body>
</html>
