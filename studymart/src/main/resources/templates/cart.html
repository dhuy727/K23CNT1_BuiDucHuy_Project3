<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Giỏ hàng - StudyMart')}"></head>
<body>
<div th:replace="~{fragments/layout :: navbar('cart')}"></div>

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-0">Giỏ hàng</h4>
            <div class="text-muted small">Kiểm tra số lượng trước khi thanh toán</div>
        </div>
        <a class="btn btn-outline-secondary" th:href="@{/}">← Tiếp tục mua</a>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="card shadow-soft border-0">
                <div class="card-body">
                    <div id="cartEmpty" class="text-center text-muted py-4 d-none">
                        Giỏ hàng trống.
                    </div>

                    <div class="table-responsive" id="cartTableWrap">
                        <table class="table align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>Sản phẩm</th>
                                <th class="text-center" style="width:160px;">Số lượng</th>
                                <th class="text-end" style="width:120px;">Xóa</th>
                            </tr>
                            </thead>
                            <tbody id="cartBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-soft border-0">
                <div class="card-body">
                    <div class="fw-semibold mb-2">Tóm tắt</div>

                    <div class="d-flex justify-content-between small">
                        <span class="text-muted">Tổng số lượng</span>
                        <span id="sumQty">0</span>
                    </div>

                    <hr>

                    <a id="btnCheckout" class="btn btn-primary w-100" th:href="@{/checkout}">
                        Tiến hành thanh toán
                    </a>

                    <button class="btn btn-outline-danger w-100 mt-2" type="button" onclick="clearCartAndReload()">
                        Xóa giỏ hàng
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function resolveImage(item){
      const u = item.imageUrl;
      if (!u) return "/images/no-image.png";
      if (u.startsWith("http://") || u.startsWith("https://")) return u;
      if (u.startsWith("/")) return u;
      return "/images/products" + u;
    }

    function formatVnd(n){
      return (Number(n||0)).toLocaleString("vi-VN") + "đ";
    }

    function renderCart(){
      const cart = getCart();
      const tbody = document.getElementById("cartBody");
      const sumQty = document.getElementById("sumQty");

      tbody.innerHTML = "";

      let totalQty = 0;

      cart.forEach((it, idx) => {
        const name = it.name || ("Sản phẩm #" + it.productId);
        const price = Number(it.price || 0);
        const qty = Number(it.quantity || 0);
        const img = resolveImage(it);
        const sub = price * qty;

        totalQty += qty;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div class="d-flex gap-3 align-items-center">
              <img src="${img}"
                   style="width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid #eee;">
              <div>
                <div class="fw-semibold">${name}</div>
                <div class="text-muted small">Giá: <b>${formatVnd(price)}</b></div>
                <div class="text-muted small">Tạm tính: <b>${formatVnd(sub)}</b></div>
              </div>
            </div>
          </td>
          <td class="text-center">
            <input type="number" min="1" value="${qty}"
                   class="form-control form-control-sm text-center"
                   style="max-width:120px;margin:0 auto;"
                   onchange="updateQty(${idx}, this.value)">
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${idx})">Xóa</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      if (sumQty) sumQty.textContent = totalQty;
    }

    function updateQty(idx, v){
      const cart = getCart();
      const q = parseInt(v);
      if (!q || q <= 0) return;
      cart[idx].quantity = q;
      saveCart(cart);
      renderCart();
      updateCartCount();
    }

    function removeItem(idx){
      const cart = getCart();
      cart.splice(idx, 1);
      saveCart(cart);
      renderCart();
      updateCartCount();
    }

    function clearCartAndReload(){
      localStorage.removeItem("BDH_CART");
      renderCart();
      updateCartCount();
    }

    document.addEventListener("DOMContentLoaded", renderCart);
</script>

<div th:replace="~{fragments/layout :: footer}"></div>
<div th:replace="~{fragments/layout :: scripts}"></div>

</body>
</html>
