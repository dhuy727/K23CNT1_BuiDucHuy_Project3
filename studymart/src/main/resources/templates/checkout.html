<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Checkout</title>
    <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css}">
</head>
<body class="bg-light">

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Thanh toán</h4>
        <a class="btn btn-outline-secondary" th:href="@{/cart}">← Giỏ hàng</a>
    </div>

    <div th:if="${msg}" class="alert alert-success" th:text="${msg}"></div>

    <div class="row g-3">
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form id="checkoutForm" th:action="@{/checkout}" method="post">
                        <div class="mb-3">
                            <label class="form-label">Địa chỉ giao hàng</label>
                            <input name="shippingAddress" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input name="phone" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <input name="note" class="form-control" placeholder="(tuỳ chọn)">
                        </div>

                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">Thanh toán</label>
                                <select class="form-select" name="paymentMethodId">
                                    <option value="">-- Chọn --</option>
                                    <option th:each="p : ${paymentMethods}" th:value="${p.id}" th:text="${p.name}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Vận chuyển</label>
                                <select class="form-select" name="transportMethodId">
                                    <option value="">-- Chọn --</option>
                                    <option th:each="t : ${transportMethods}" th:value="${t.id}" th:text="${t.name}"></option>
                                </select>
                            </div>
                        </div>

                        <!-- cart JSON from localStorage -->
                        <input type="hidden" name="cartJson" id="cartJson"/>

                        <button id="btnPlaceOrder" class="btn btn-primary w-100 mt-3" type="submit">Đặt hàng</button>

                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="fw-semibold mb-2">Tóm tắt giỏ hàng</div>
                    <div id="cartSummary" class="small text-muted">Đang tải...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const CART_KEY = "BDH_CART";

    function getCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
      catch(e) { return []; }
    }

    function renderSummary(cart) {
      const el = document.getElementById("cartSummary");
      if (!cart.length) {
        el.innerHTML = `<div class="text-danger">Giỏ hàng trống. Vui lòng thêm sản phẩm trước.</div>`;
        return;
      }
      el.innerHTML = cart.map(i => `• Product #${i.productId} x ${i.quantity}`).join("<br>");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const cart = getCart();
      renderSummary(cart);

      document.getElementById("checkoutForm").addEventListener("submit", (e) => {
      const cartNow = getCart();
      if (!cartNow.length) {
        e.preventDefault();
        alert("Giỏ hàng trống!");
        return;
      }
      document.getElementById("cartJson").value = JSON.stringify(cartNow);
    });
    });
</script>
</body>
</html>
